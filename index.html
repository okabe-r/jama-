<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>الجمع بين الصحيحين</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Naskh+Arabic:wght@400;600;700&family=Amiri:wght@400;700&display=swap" rel="stylesheet">
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.2.0",
    "react-dom/client": "https://esm.sh/react-dom@18.2.0/client"
  }
}
</script>
<style>
:root {
    --primary: #1abc9c;
    --primary-dark: #16a085;
    --danger: #e74c3c;
    --danger-dark: #c0392b;
    --info: #3498db;
    --card-bg: #ffffff;
    --card-border: #e0e0e0;
    --card-front-bg: #e8f5e9;
    --card-front-text: #1a5a3b;
    --card-front-border: #c8e6c9;
    --text-main: #34495e;
    --text-secondary: #555;
    --bg-main: #f4f7f6;
    --bg-container: #ffffff;
    --shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    --border-radius: 8px;
    --diff-correct: #27ae60;
    --diff-missing-bg: #ffebee;
    --diff-added-bg: #fffde7;
    --diff-missing-text: #c0392b;
    --diff-added-text: #f39c12;
    --modal-overlay-bg: rgba(0, 0, 0, 0.6);
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
    font-family: 'Noto Naskh Arabic', 'Amiri', serif;
    direction: rtl;
    background-color: var(--bg-main);
    color: var(--text-main);
    line-height: 1.8;
    padding: 20px;
    font-size: 16px;
}

#app-container {
    max-width: 1200px;
    margin: 30px auto;
    background-color: var(--bg-container);
    padding: 25px 35px;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow);
    text-align: center;
    position: relative;
}

header { margin-bottom: 35px; }
header h1 {
    color: var(--text-main);
    font-size: 2.6em;
    font-weight: 700;
    padding-bottom: 15px;
    border-bottom: 2px solid var(--primary);
    display: inline-block;
}

h2 {
    color: var(--primary-dark);
    margin-bottom: 25px;
    font-size: 1.9em;
    font-weight: 600;
}

.view {
    display: none;
    animation: fadeIn 0.5s ease-in-out;
}
.active-view { display: block; }

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(15px); }
    to { opacity: 1; transform: translateY(0); }
}

button {
    font-family: inherit;
    cursor: pointer;
    border: none;
    border-radius: 5px;
    transition: background-color 0.25s ease, transform 0.1s ease;
    font-weight: 600;
    padding: 10px 20px;
    font-size: 1em;
    margin: 5px;
}
button:active { transform: scale(0.97); }

#section-buttons-container {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 15px;
    margin: 25px 0;
}

.section-button {
    flex: 1 1 300px;
    min-width: 250px;
    padding: 12px 22px;
    font-size: 1.1em;
    background-color: var(--primary);
    color: white;
}
.section-button:hover { background-color: var(--primary-dark); }

.navigation-controls { margin-bottom: 20px; }
.back-button {
    background-color: var(--danger);
    color: white;
}
.back-button:hover { background-color: var(--danger-dark); }

#hadith-cards-container {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 25px;
    margin-top: 30px;
    padding: 10px;
    perspective: 1200px;
}

.card-container {
    width: 320px;
    height: 240px;
    z-index: 1;
    position: relative;
}

.card {
    width: 100%;
    height: 100%;
    position: relative;
    transform-style: preserve-3d;
    transition: transform 0.7s cubic-bezier(0.4, 0.2, 0.2, 1);
    cursor: pointer;
    border-radius: var(--border-radius);
    box-shadow: 0 2px 8px rgba(0,0,0,0.07);
}

.card.is-flipped {
    transform: rotateY(180deg);
    z-index: 2;
}

.card-face {
    position: absolute;
    width: 100%;
    height: 100%;
    backface-visibility: hidden;
    border-radius: var(--border-radius);
    padding: 18px;
    border: 1px solid var(--card-border);
    background-color: var(--card-bg);
    display: flex;
    flex-direction: column;
}

.card-front {
    background-color: var(--card-front-bg);
    color: var(--card-front-text);
    border-color: var(--card-front-border);
    justify-content: center;
    align-items: center;
    text-align: center;
    z-index: 1;
}

.card-back {
    background-color: var(--card-bg);
    color: var(--text-secondary);
    transform: rotateY(180deg);
    overflow-y: auto;
    font-size: 0.95em;
    line-height: 1.8;
    z-index: 2;
}

.bab-name-wrapper {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    flex-grow: 1;
}

.bab-name {
    font-weight: bold;
    font-size: 1.1em;
    line-height: 1.5;
}

.bab-number-badge {
    background-color: var(--info);
    color: white;
    font-size: 1em;
    font-weight: bold;
    padding: 2px 8px;
    border-radius: 4px;
    line-height: 1.4;
    min-width: 28px;
    text-align: center;
}

.hadith-number {
    font-size: 0.85em;
    color: #555;
    position: absolute;
    top: 10px;
    left: 10px;
    background-color: rgba(0, 0, 0, 0.05);
    padding: 2px 8px;
    border-radius: 4px;
    z-index: 1;
}

.card-back .hadith-text { 
    text-align: justify; 
}

.card-back::-webkit-scrollbar { width: 8px; }
.card-back::-webkit-scrollbar-track { background: #f1f1f1; }
.card-back::-webkit-scrollbar-thumb { background: #ccc; }
.card-back::-webkit-scrollbar-thumb:hover { background: #aaa; }

.transcribe-button {
    background-color: var(--info);
    color: white;
    padding: 6px 12px;
    font-size: 0.85em;
    margin-top: 15px;
    align-self: center;
}

.transcribe-button:hover {
    background-color: #2980b9;
}


/* Modal Styles */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: var(--modal-overlay-bg);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    animation: fadeIn 0.3s;
}

.modal-content {
    background-color: var(--bg-container);
    padding: 30px;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow);
    width: 90%;
    max-width: 700px;
    max-height: 90vh;
    overflow-y: auto;
    position: relative;
    text-align: right;
    animation: slideIn 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
}
@keyframes slideIn {
    from { opacity: 0; transform: translateY(50px); }
    to { opacity: 1; transform: translateY(0); }
}

.modal-content h3 {
    text-align: center;
    margin-bottom: 20px;
    color: var(--primary-dark);
}

.modal-content .bab-reference {
    text-align: center;
    margin-bottom: 20px;
    font-size: 1.1em;
    font-weight: bold;
    color: var(--text-main);
}

.modal-content textarea {
    width: 100%;
    height: 200px;
    font-family: inherit;
    font-size: 1.1em;
    padding: 15px;
    border: 1px solid var(--card-border);
    border-radius: var(--border-radius);
    margin-bottom: 20px;
    resize: vertical;
}

.modal-close-button {
    position: absolute;
    top: 15px;
    left: 15px;
    background: transparent;
    border: none;
    font-size: 1.8em;
    cursor: pointer;
    color: var(--text-secondary);
}

.modal-actions {
    text-align: center;
}

.comparison-view {
    text-align: right;
    line-height: 2.2;
    font-size: 1.1em;
}

.comparison-view p {
    white-space: pre-wrap;
    word-break: break-word;
}

.comparison-view h4 {
    margin-top: 20px;
    margin-bottom: 10px;
    border-bottom: 1px solid var(--card-border);
    padding-bottom: 5px;
}

.diff-correct { color: var(--diff-correct); }
.diff-missing { background-color: var(--diff-missing-bg); color: var(--diff-missing-text); text-decoration: line-through; padding: 2px 4px; border-radius: 3px;}
.diff-added { background-color: var(--diff-added-bg); color: var(--diff-added-text); padding: 2px 4px; border-radius: 3px; }


footer {
    margin-top: 40px;
    padding-top: 20px;
    border-top: 1px solid var(--card-border);
    font-size: 0.9rem;
    color: #777;
}

@media (max-width: 768px) {
    header h1 { font-size: 2.2em; }
    .card-container { width: 90%; }
}

@media (max-width: 480px) {
    header h1 { font-size: 1.9em; }
    .card-container { width: 95%; min-height: 220px; }
    .bab-name { font-size: 1.05em; }
}
</style>
</head>
<body>
    <div id="root"></div>
<script type="module">
import React from 'react';
import { createRoot } from 'react-dom/client';

const { useState, useMemo, useEffect, useRef } = React;

const toArabicNumerals = (num) => {
    const arabicNumerals = ['٠', '١', '٢', '٣', '٤', '٥', '٦', '٧', '٨', '٩'];
    return String(num).split('').map(digit => arabicNumerals[parseInt(digit, 10)]).join('');
};

const normalizeArabic = (text) => {
  if (!text) return '';
  return text
    .replace(/[\u064B-\u0652]/g, "") // Remove harakat
    .replace(/[أإآ]/g, "ا")
    .replace(/ة/g, "ه")
    .replace(/ى/g, "ي")
    .replace(/\s+/g, ' ') // Collapse whitespace
    .trim();
};

const diffWords = (oldStr, newStr) => {
    const cleanOldStr = oldStr.replace(/<br\s*\/?>/gi, " ");
    const cleanNewStr = newStr.replace(/<br\s*\/?>/gi, " ");

    const punctuationRegex = /[.,()\[\]\/#!$؟%\^&\*;:{}=_`~،؛«»﴿﴾ﷺ●-]/g;
    const normalizeWordForDiff = (word) => normalizeArabic(word).replace(punctuationRegex, '');

    const oldWords = cleanOldStr.split(/\s+/).filter(Boolean);
    const newWords = cleanNewStr.split(/\s+/).filter(Boolean);

    const m = oldWords.length;
    const n = newWords.length;
    const dp = Array(m + 1).fill(0).map(() => Array(n + 1).fill(0));

    for (let i = 1; i <= m; i++) {
        for (let j = 1; j <= n; j++) {
            if (normalizeWordForDiff(oldWords[i - 1]) === normalizeWordForDiff(newWords[j - 1])) {
                dp[i][j] = dp[i - 1][j - 1] + 1;
            } else {
                dp[i][j] = Math.max(dp[i - 1][j], dp[i][j - 1]);
            }
        }
    }

    const wordDiffs = [];
    let i = m, j = n;
    while (i > 0 || j > 0) {
        if (i > 0 && j > 0 && normalizeWordForDiff(oldWords[i - 1]) === normalizeWordForDiff(newWords[j - 1])) {
            wordDiffs.unshift({ value: oldWords[i - 1], type: 'correct' });
            i--;
            j--;
        } else if (j > 0 && (i === 0 || dp[i][j - 1] >= dp[i - 1][j])) {
            wordDiffs.unshift({ value: newWords[j - 1], type: 'added' });
            j--;
        } else if (i > 0 && (j === 0 || dp[i][j - 1] < dp[i - 1][j])) {
            wordDiffs.unshift({ value: oldWords[i - 1], type: 'missing' });
            i--;
        } else {
            break;
        }
    }
    
    if (wordDiffs.length === 0) {
        const result = [];
        if (oldWords.length > 0) result.push({ value: oldWords.join(' '), type: 'missing'});
        if (newWords.length > 0) result.push({ value: newWords.join(' '), type: 'added'});
        return result;
    }

    const groupedResult = [];
    let currentPart = { ...wordDiffs[0] };

    for (let k = 1; k < wordDiffs.length; k++) {
        const nextPart = wordDiffs[k];
        if (nextPart.type === currentPart.type) {
            currentPart.value += ' ' + nextPart.value;
        } else {
            groupedResult.push(currentPart);
            currentPart = { ...nextPart };
        }
    }
    groupedResult.push(currentPart);

    return groupedResult;
};


const TranscriptionModal = ({ cardData, onClose }) => {
    const [userInput, setUserInput] = useState('');
    const [comparison, setComparison] = useState(null);
    const modalRef = useRef(null);

    useEffect(() => {
        const handleKeyDown = (event) => {
            if (event.key === 'Escape') {
                onClose();
            }
        };
        window.addEventListener('keydown', handleKeyDown);
        document.body.style.overflow = 'hidden';
        
        if (modalRef.current) {
            modalRef.current.focus();
        }

        return () => {
            window.removeEventListener('keydown', handleKeyDown);
            document.body.style.overflow = 'auto';
        };
    }, [onClose]);

    const handleCorrection = () => {
        const diffResult = diffWords(cardData.backText, userInput);
        setComparison(diffResult);
    };

    const handleTryAgain = () => {
        setComparison(null);
        setUserInput('');
    };

    const renderComparison = (diff, type) => {
        if (!diff) return null;
        return diff.map((part, index) => {
            if (type === 'user' && part.type === 'missing') return null;
            if (type === 'original' && part.type === 'added') return null;
            
            const className = `diff-${part.type}`;

            return React.createElement('span', { key: index, className: className }, part.value + ' ');
        });
    };

    return React.createElement('div', { className: 'modal-overlay', onClick: onClose },
        React.createElement('div', { className: 'modal-content', onClick: e => e.stopPropagation(), ref: modalRef, tabIndex: -1, role: 'dialog', 'aria-modal': true },
            React.createElement('button', { className: 'modal-close-button', onClick: onClose, 'aria-label': 'إغلاق' }, '×'),
            React.createElement('h3', null, 'اكتب الحديث'),
            React.createElement('p', { className: 'bab-reference' }, cardData.bab),
            !comparison ? (
                React.createElement(React.Fragment, null,
                    React.createElement('textarea', {
                        value: userInput,
                        onChange: e => setUserInput(e.target.value),
                        placeholder: 'اكتب الحديث هنا...',
                        'aria-label': 'صندوق إدخال الحديث'
                    }),
                    React.createElement('div', { className: 'modal-actions' },
                        React.createElement('button', { className: 'section-button', onClick: handleCorrection }, 'تصحيح الإجابة')
                    )
                )
            ) : (
                React.createElement('div', { className: 'comparison-view' },
                    React.createElement('h4', null, 'إجابتك'),
                    React.createElement('p', null, renderComparison(comparison, 'user')),
                    React.createElement('h4', null, 'الإجابة الصحيحة (بدون حركات)'),
                    React.createElement('p', null, renderComparison(comparison, 'original')),
                    React.createElement('div', { className: 'modal-actions' },
                        React.createElement('button', { className: 'section-button', onClick: handleTryAgain }, 'حاول مرة أخرى')
                    )
                )
            )
        )
    );
};


const processHadithsData = (hadiths) => {
    const babCounts = hadiths.reduce((acc, h) => {
        acc[h.bab] = (acc[h.bab] || 0) + 1;
        return acc;
    }, {});
    const babIndices = {};

    return hadiths.map(hadith => {
        const count = babCounts[hadith.bab];
        const currentIndex = (babIndices[hadith.bab] || 0) + 1;
        babIndices[hadith.bab] = currentIndex;
        return { 
            id: hadith.id, 
            bab: hadith.bab, 
            babIndex: currentIndex, 
            babCount: count, 
            backText: hadith.text 
        };
    });
};

const HadithCard = ({ cardData }) => {
    const [isFlipped, setIsFlipped] = useState(false);
    const [isModalOpen, setIsModalOpen] = useState(false);
    const toggleFlip = () => setIsFlipped(!isFlipped);
    const createMarkup = (htmlString) => ({ __html: htmlString });

    const openModal = (e) => {
        e.stopPropagation();
        setIsModalOpen(true);
    };

    const closeModal = () => {
        setIsModalOpen(false);
    };

    return React.createElement(React.Fragment, null,
        isModalOpen && React.createElement(TranscriptionModal, { cardData, onClose: closeModal }),
        React.createElement('div', { className: "card-container", onClick: toggleFlip, role: "button", tabIndex: 0 },
            React.createElement('div', { className: `card ${isFlipped ? 'is-flipped' : ''}` },
                React.createElement('div', { className: 'card-face card-front' },
                    React.createElement('span', { className: 'hadith-number' }, `حديث: ${toArabicNumerals(cardData.id)}`),
                    React.createElement('div', { className: 'bab-name-wrapper' },
                        React.createElement('span', { className: "bab-name" }, cardData.bab),
                        cardData.babCount > 1 && React.createElement('span', { className: 'bab-number-badge' }, toArabicNumerals(cardData.babIndex))
                    ),
                    React.createElement('button', { className: 'transcribe-button', onClick: openModal }, 'كتابة الحديث')
                ),
                React.createElement('div', { className: 'card-face card-back' },
                     React.createElement('p', { className: "hadith-text", dangerouslySetInnerHTML: createMarkup(cardData.backText) })
                )
            )
        )
    );
};

const App = () => {
    const [allHadiths, setAllHadiths] = useState([]);
    const [isLoading, setIsLoading] = useState(true);
    const [error, setError] = useState(null);
    const [view, setView] = useState('book-selection');
    const [currentBookName, setCurrentBookName] = useState(null);
    const [currentGroup, setCurrentGroup] = useState(null);

    useEffect(() => {
        fetch('./hadiths.json')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                setAllHadiths(data);
            })
            .catch(e => {
                console.error("Failed to load hadiths.json", e);
                setError("فشل تحميل ملف الأحاديث. الرجاء التأكد من وجود ملف 'hadiths.json'.");
            })
            .finally(() => {
                setIsLoading(false);
            });
    }, []);

    const uniqueBooks = useMemo(() => {
        if (!allHadiths || allHadiths.length === 0 || allHadiths.every(h => !h.book)) return [];
        return [...new Set(allHadiths.map(h => h.book))];
    }, [allHadiths]);

    const hadithGroups = useMemo(() => {
        if (!currentBookName || !allHadiths || allHadiths.length === 0) return [];
        const hadithsOfBook = allHadiths.filter(h => h.book === currentBookName);
        if (hadithsOfBook.length === 0) return [];

        const groups = [];
        const groupSize = 10;
        for (let i = 0; i < hadithsOfBook.length; i += groupSize) {
            const startHadith = hadithsOfBook[i];
            const endHadith = hadithsOfBook[Math.min(i + groupSize - 1, hadithsOfBook.length - 1)];
            groups.push({ start: startHadith.id, end: endHadith.id });
        }
        
        if (groups.length > 1) {
            const lastGroup = groups[groups.length - 1];
            if (lastGroup.end - lastGroup.start + 1 <= 1) { // Merge if last group is tiny
                const secondLastGroup = groups[groups.length - 2];
                secondLastGroup.end = lastGroup.end;
                groups.pop();
            }
        }
        return groups;
    }, [currentBookName, allHadiths]);

    const processedHadiths = useMemo(() => {
        if (!allHadiths || allHadiths.length === 0 || allHadiths.every(h => !h.book)) return [];
        return processHadithsData(allHadiths);
    }, [allHadiths]);

    const hadithsForCurrentGroup = useMemo(() => {
        if (!currentGroup || !processedHadiths.length) return [];
        return processedHadiths.filter(
            h => h.id >= currentGroup.start && h.id <= currentGroup.end
        );
    }, [currentGroup, processedHadiths]);
    
    if (isLoading) {
        return React.createElement('div', { id: "app-container" },
            React.createElement('header', null,
                React.createElement('h1', null, "الجمع بين الصحيحين")
            ),
            React.createElement('p', null, "جار تحميل البيانات...")
        );
    }
    
    if (error) {
         return React.createElement('div', { id: "app-container" },
            React.createElement('header', null,
                React.createElement('h1', null, "الجمع بين الصحيحين")
            ),
            React.createElement('p', { style: { color: 'red' } }, error)
        );
    }

    if (!allHadiths || allHadiths.length === 0 || allHadiths.every(h => !h.book)) {
        return React.createElement('div', { id: "app-container" },
            React.createElement('header', null,
                React.createElement('h1', null, "الجمع بين الصحيحين")
            ),
            React.createElement('p', null, "الرجاء ملء ملف 'hadiths.json' بالأحاديث لتشغيل التطبيق.")
        );
    }

    const handleBookClick = (bookName) => {
        setCurrentBookName(bookName);
        setView('group-selection');
    };

    const handleGroupClick = (group) => {
        setCurrentGroup(group);
        setView('hadith-display');
        window.scrollTo(0, 0);
    };

    const handleBackToBooks = () => {
        setView('book-selection');
        setCurrentBookName(null);
        setCurrentGroup(null);
    };
    
    const handleBackToGroups = () => {
        setView('group-selection');
        setCurrentGroup(null);
    };

    return React.createElement('div', { id: "app-container" },
        React.createElement('header', null,
            React.createElement('h1', null, "الجمع بين الصحيحين")
        ),
        React.createElement('main', { id: "content-area" },
            view === 'book-selection' && React.createElement('div', { className: "view active-view" },
                React.createElement('h2', null, "اختر كتابًا"),
                React.createElement('div', { id: "section-buttons-container" },
                    uniqueBooks.map(book =>
                        React.createElement('button', { key: book, className: "section-button", onClick: () => handleBookClick(book) }, book)
                    )
                )
            ),
            view === 'group-selection' && React.createElement('div', { className: "view active-view" },
                React.createElement('h2', null, currentBookName),
                 React.createElement('div', { className: "navigation-controls" },
                    React.createElement('button', { className: "back-button", onClick: handleBackToBooks }, "← العودة للكتب")
                ),
                React.createElement('div', { id: "section-buttons-container" },
                    hadithGroups.map(group =>
                        React.createElement('button', { 
                            key: `${group.start}-${group.end}`, 
                            className: "section-button", 
                            onClick: () => handleGroupClick(group) 
                        }, `الأحاديث ${toArabicNumerals(group.start)} - ${toArabicNumerals(group.end)}`)
                    )
                )
            ),
            view === 'hadith-display' && React.createElement('div', { className: "view active-view" },
                React.createElement('h2', null, `${currentBookName} (الأحاديث ${toArabicNumerals(currentGroup.start)} - ${toArabicNumerals(currentGroup.end)})`),
                React.createElement('div', { className: "navigation-controls" },
                    React.createElement('button', { className: "back-button", onClick: handleBackToGroups }, "← العودة للمجموعات")
                ),
                React.createElement('div', { id: "hadith-cards-container" },
                    hadithsForCurrentGroup.map(card =>
                        React.createElement(HadithCard, { key: card.id, cardData: card })
                    )
                )
            )
        ),
        React.createElement('footer', null, React.createElement('p', null, "© 2024"))
    );
};

const container = document.getElementById('root');
if (container) {
    const root = createRoot(container);
    root.render(React.createElement(App));
}
</script>
</body>
</html>
